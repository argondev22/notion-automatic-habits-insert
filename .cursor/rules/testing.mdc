---
globs: app/src/**/*.test.ts,app/src/**/*.spec.ts
---

# ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨ãƒ‘ã‚¿ãƒ¼ãƒ³

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1. **ãƒ†ã‚¹ãƒˆã®éšå±¤æ§‹é€ **

```
[feature]/
â”œâ”€â”€ __tests__/                 # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ integration/          # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ e2e/                  # ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ [Feature]Repository.test.ts
â”œâ”€â”€ services/
â”‚   â””â”€â”€ [Feature]Service.test.ts
â”œâ”€â”€ mappers/
â”‚   â””â”€â”€ [Feature]Mapper.test.ts
â””â”€â”€ factories/
    â””â”€â”€ ServiceFactory.test.ts
```

### 2. **ãƒ†ã‚¹ãƒˆã®ç¨®é¡ã¨è²¬ä»»**

```typescript
// âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ - å€‹åˆ¥ã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆ
describe('[Feature]Repository', () => {
  // ãƒ¢ãƒƒã‚¯æ³¨å…¥ã«ã‚ˆã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆ
});

// âœ… çµ±åˆãƒ†ã‚¹ãƒˆ - è¤‡æ•°ã‚¯ãƒ©ã‚¹ã®é€£æºãƒ†ã‚¹ãƒˆ
describe('[Feature] Integration', () => {
  // å®Ÿéš›ã®ä¾å­˜é–¢ä¿‚ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆ
});

// âœ… E2Eãƒ†ã‚¹ãƒˆ - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
describe('E2E [Feature] Flow', () => {
  // å®Ÿéš›ã®APIã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆ
});
```

## ğŸ”§ ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. **Repositoryå±¤ã®ãƒ†ã‚¹ãƒˆ**

```typescript
describe('[Feature]Repository', () => {
  let repository: [Feature]Repository;
  let mockService: jest.Mocked<[Feature]Service>;
  let mockMapper: jest.Mocked<[Feature]Mapper>;
  let mockLogger: jest.Mocked<ILogger>;
  let mockCache: jest.Mocked<ICache<[Feature][]>>;

  beforeEach(() => {
    // âœ… ãƒ¢ãƒƒã‚¯ã®è¨­å®š
    mockService = {
      queryData: jest.fn(),
      getContent: jest.fn(),
    } as jest.Mocked<[Feature]Service>;

    mockMapper = {
      mapTo[Feature]: jest.fn(),
    } as jest.Mocked<[Feature]Mapper>;

    mockLogger = {
      info: jest.fn(),
      debug: jest.fn(),
      error: jest.fn(),
      warn: jest.fn(),
    } as jest.Mocked<ILogger>;

    mockCache = {
      get: jest.fn(),
      set: jest.fn(),
    } as jest.Mocked<ICache<[Feature][]>>;

    repository = new [Feature]Repository(
      mockService,
      mockMapper,
      mockLogger,
      mockCache
    );
  });

  describe('fetch[Features]', () => {
    it('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹', async () => {
      // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆã®ãƒ†ã‚¹ãƒˆ
      const cached[Features] = [mock[Feature]];
      mockCache.get.mockReturnValue(cached[Features]);

      const result = await repository.fetch[Features]('id');

      expect(result).toBe(cached[Features]);
      expect(mockCache.get).toHaveBeenCalledWith('[features]:id');
      expect(mockService.queryData).not.toHaveBeenCalled();
    });

    it('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã™ã‚‹', async () => {
      // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ã®ãƒ†ã‚¹ãƒˆ
      mockCache.get.mockReturnValue(null);
      mockService.queryData.mockResolvedValue(mockDataResponse);
      mockMapper.mapTo[Feature].mockResolvedValue(mock[Feature]);

      const result = await repository.fetch[Features]('id');

      expect(mockService.queryData).toHaveBeenCalledWith('id');
      expect(mockCache.set).toHaveBeenCalledWith('[features]:id', [mock[Feature]]);
      expect(result).toEqual([mock[Feature]]);
    });

    it('ã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ã«ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹', async () => {
      // âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
      const error = new Error('Database error');
      mockCache.get.mockReturnValue(null);
      mockService.queryData.mockRejectedValue(error);

      await expect(repository.fetch[Features]('id')).rejects.toThrow(error);
      expect(mockLogger.error).toHaveBeenCalledWith(
        '[Features]å–å¾—ã‚¨ãƒ©ãƒ¼',
        error,
        expect.any(Object)
      );
    });
  });
});
```

### 2. **Serviceå±¤ã®ãƒ†ã‚¹ãƒˆ**

```typescript
describe('NotionDatabaseService', () => {
  let service: NotionDatabaseService;
  let mockLogger: jest.Mocked<ILogger>;
  let mockCache: jest.Mocked<ICache<DatabaseResponse>>;
  let mockContentCache: jest.Mocked<ICache<BlockObjectResponse>>;
  let mockRetryManager: jest.Mocked<RetryManager>;

  beforeEach(() => {
    // âœ… ãƒ¢ãƒƒã‚¯ã®è¨­å®š
    mockLogger = createMockLogger();
    mockCache = createMockCache<DatabaseResponse>();
    mockContentCache = createMockCache<BlockObjectResponse>();
    mockRetryManager = createMockRetryManager();

    service = new NotionDatabaseService(
      mockLogger,
      mockCache,
      mockContentCache,
      mockRetryManager
    );
  });

  describe('queryDatabase', () => {
    it('ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼æ™‚ã«FetchErrorã‚’æŠ•ã’ã‚‹', async () => {
      // âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
      await expect(service.queryDatabase('')).rejects.toThrow(FetchError);
      await expect(service.queryDatabase('invalid-id')).rejects.toThrow(FetchError);
    });

    it('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™', async () => {
      // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
      const cachedData = mockDatabaseResponse;
      mockCache.get.mockReturnValue(cachedData);

      const result = await service.queryDatabase('database-id');

      expect(result).toBe(cachedData);
      expect(mockCache.get).toHaveBeenCalledWith('database:database-id');
    });

    it('ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async () => {
      // âœ… ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
      mockCache.get.mockReturnValue(null);
      mockRetryManager.execute.mockResolvedValue(mockDatabaseResponse);

      const result = await service.queryDatabase('database-id');

      expect(mockRetryManager.execute).toHaveBeenCalled();
      expect(mockCache.set).toHaveBeenCalledWith('database:database-id', mockDatabaseResponse);
      expect(result).toBe(mockDatabaseResponse);
    });
  });
});
```

### 3. **Mapperå±¤ã®ãƒ†ã‚¹ãƒˆ**

```typescript
describe('HabitMapper', () => {
  let mapper: HabitMapper;
  let mockLogger: jest.Mocked<ILogger>;

  beforeEach(() => {
    mockLogger = createMockLogger();
    mapper = new HabitMapper(mockLogger);
  });

  describe('mapToHabit', () => {
    it('æ­£å¸¸ãªãƒšãƒ¼ã‚¸ã‚’Habitãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›ã™ã‚‹', async () => {
      // âœ… æ­£å¸¸ãªå¤‰æ›ã®ãƒ†ã‚¹ãƒˆ
      const mockPage = createMockPage();
      const mockContent = createMockContent();

      const result = await mapper.mapToHabit(mockPage, mockContent);

      expect(result).toEqual({
        name: 'Test Habit',
        startTime: '07:00',
        endTime: '08:00',
        days: [Day.MONDAY, Day.WEDNESDAY],
        profiles: ['å¥åº·ç¶­æŒ'],
        tobes: ['ä½“åŠ›å‘ä¸Š'],
        content: mockContent,
      });
    });

    it('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§FetchErrorã‚’æŠ•ã’ã‚‹', async () => {
      // âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
      const invalidPage = createInvalidPage();
      const mockContent = createMockContent();

      await expect(mapper.mapToHabit(invalidPage, mockContent)).rejects.toThrow(FetchError);
      expect(mockLogger.error).toHaveBeenCalledWith(
        `å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${invalidPage.id}`,
        expect.any(Error)
      );
    });

    it('æ›œæ—¥ã®å¤‰æ›ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async () => {
      // âœ… æ›œæ—¥å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ
      const pageWithDays = createPageWithDays(['MON', 'TUE', 'WED']);
      const mockContent = createMockContent();

      const result = await mapper.mapToHabit(pageWithDays, mockContent);

      expect(result.days).toEqual([Day.MONDAY, Day.TUESDAY, Day.WEDNESDAY]);
    });
  });
});
```

### 4. **Factoryå±¤ã®ãƒ†ã‚¹ãƒˆ**

```typescript
describe('ServiceFactory', () => {
  beforeEach(() => {
    // âœ… ãƒ†ã‚¹ãƒˆå‰ã®ãƒªã‚»ãƒƒãƒˆ
    ServiceFactory.reset();
  });

  afterEach(() => {
    // âœ… ãƒ†ã‚¹ãƒˆå¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    ServiceFactory.reset();
  });

  describe('initialize', () => {
    it('ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£ã—ãç™»éŒ²ã•ã‚Œã‚‹', () => {
      // âœ… ã‚µãƒ¼ãƒ“ã‚¹ç™»éŒ²ã®ãƒ†ã‚¹ãƒˆ
      ServiceFactory.initialize();

      expect(ServiceFactory.getService<ILogger>('logger')).toBeDefined();
      expect(ServiceFactory.getService<ICache<DatabaseResponse>>('cache')).toBeDefined();
      expect(ServiceFactory.getService<HabitRepository>('habitRepository')).toBeDefined();
    });
  });

  describe('getService', () => {
    it('ç™»éŒ²ã•ã‚Œã¦ã„ãªã„ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹', () => {
      // âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
      expect(() => {
        ServiceFactory.getService('nonExistentService');
      }).toThrow('Service not found: nonExistentService');
    });
  });
});
```

## ğŸ”§ ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

### 1. **ãƒ¢ãƒƒã‚¯ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸãƒ¢ãƒƒã‚¯ä½œæˆ
export function createMockLogger(): jest.Mocked<ILogger> {
  return {
    info: jest.fn(),
    debug: jest.fn(),
    error: jest.fn(),
    warn: jest.fn(),
  } as jest.Mocked<ILogger>;
}

export function createMockCache<T>(): jest.Mocked<ICache<T>> {
  return {
    get: jest.fn(),
    set: jest.fn(),
    clear: jest.fn(),
    has: jest.fn(),
  } as jest.Mocked<ICache<T>>;
}

export function createMockRetryManager(): jest.Mocked<RetryManager> {
  return {
    execute: jest.fn(),
  } as jest.Mocked<RetryManager>;
}
```

### 2. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
export function createMockHabit(): Habit {
  return {
    name: 'Test Habit',
    startTime: '07:00',
    endTime: '08:00',
    days: [Day.MONDAY, Day.WEDNESDAY],
    profiles: ['å¥åº·ç¶­æŒ'],
    tobes: ['ä½“åŠ›å‘ä¸Š'],
    content: createMockContent(),
  };
}

export function createMockPage(): PageResponse {
  return {
    id: 'test-page-id',
    object: 'page',
    created_time: '2023-01-01T00:00:00.000Z',
    last_edited_time: '2023-01-01T00:00:00.000Z',
    properties: {
      Name: { title: [{ plain_text: 'Test Habit' }] },
      StartTime: { rich_text: [{ plain_text: '07:00' }] },
      // ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
    },
  } as PageResponse;
}
```

## ğŸ“‹ ãƒ†ã‚¹ãƒˆã®å¿…é ˆé …ç›®

### 1. **ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: beforeEach/afterEachã§ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
beforeEach(() => {
  jest.clearAllMocks();
  ServiceFactory.reset();
});

afterEach(() => {
  ServiceFactory.reset();
});

// âœ… å¿…é ˆ: é©åˆ‡ãªã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
expect(result).toBeDefined();
expect(mockFunction).toHaveBeenCalledWith(expectedArgs);
expect(mockFunction).toHaveBeenCalledTimes(expectedCount);
```

### 2. **Repositoryå±¤ã®ãƒ†ã‚¹ãƒˆã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
it('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™', async () => {
  mockCache.get.mockReturnValue(cachedData);
  const result = await repository.fetchHabits('id');
  expect(result).toBe(cachedData);
});

// âœ… å¿…é ˆ: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ
it('ã‚¨ãƒ©ãƒ¼æ™‚ã«é©åˆ‡ã«ãƒ­ã‚°å‡ºåŠ›ã™ã‚‹', async () => {
  const error = new Error('Test error');
  mockDatabaseService.queryDatabase.mockRejectedValue(error);
  await expect(repository.fetchHabits('id')).rejects.toThrow(error);
});
```

### 3. **Serviceå±¤ã®ãƒ†ã‚¹ãƒˆã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ
it('ç„¡åŠ¹ãªå…¥åŠ›ã§FetchErrorã‚’æŠ•ã’ã‚‹', async () => {
  await expect(service.queryDatabase('')).rejects.toThrow(FetchError);
});

// âœ… å¿…é ˆ: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
it('ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ãŒæ­£ã—ãå‹•ä½œã™ã‚‹', async () => {
  mockRetryManager.execute.mockResolvedValue(mockData);
  const result = await service.queryDatabase('id');
  expect(mockRetryManager.execute).toHaveBeenCalled();
});
```

### 4. **Mapperå±¤ã®ãƒ†ã‚¹ãƒˆã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: å‹å®‰å…¨ãªå¤‰æ›ã®ãƒ†ã‚¹ãƒˆ
it('æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿ã‚’æ­£ã—ãå¤‰æ›ã™ã‚‹', async () => {
  const result = await mapper.mapToHabit(mockPage, mockContent);
  expect(result).toEqual(expectedHabit);
});

// âœ… å¿…é ˆ: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
it('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã§FetchErrorã‚’æŠ•ã’ã‚‹', async () => {
  await expect(mapper.mapToHabit(invalidPage, mockContent)).rejects.toThrow(FetchError);
});
```

## ğŸš« ãƒ†ã‚¹ãƒˆã®ç¦æ­¢äº‹é …

### 1. **ãƒ†ã‚¹ãƒˆã®åˆ†é›¢é•å**

```typescript
// âŒ ç¦æ­¢: ãƒ†ã‚¹ãƒˆé–“ã§ã®çŠ¶æ…‹å…±æœ‰
let sharedState = {};

// âŒ ç¦æ­¢: ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã®å¤‰æ›´
global.someState = 'modified';
```

### 2. **ä¸é©åˆ‡ãªãƒ¢ãƒƒã‚¯**

```typescript
// âŒ ç¦æ­¢: éåº¦ãªãƒ¢ãƒƒã‚¯
jest.mock('../../../shared/logger/Logger', () => ({
  LoggerFactory: {
    getLogger: jest.fn().mockReturnValue({
      info: jest.fn(),
      debug: jest.fn(),
      error: jest.fn(),
      warn: jest.fn(),
    }),
  },
}));

// âŒ ç¦æ­¢: å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ï¼ˆå˜ä½“ãƒ†ã‚¹ãƒˆã§ï¼‰
const result = await fetchHabits(); // å®Ÿéš›ã®Notion APIã‚’å‘¼ã³å‡ºã—
```

### 3. **ãƒ†ã‚¹ãƒˆã®ä¸å®Œå…¨æ€§**

```typescript
// âŒ ç¦æ­¢: ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã®ãƒ†ã‚¹ãƒˆ
it('should work', async () => {
  await someFunction();
  // ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãªã— - ç¦æ­¢
});

// âŒ ç¦æ­¢: ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆãªã—
it('æ­£å¸¸ã‚±ãƒ¼ã‚¹ã®ã¿', async () => {
  const result = await function();
  expect(result).toBeDefined();
  // ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆãªã— - ç¦æ­¢
});
```

## ğŸ“š å‚è€ƒå®Ÿè£…

- [convert.test.ts](mdc:app/src/domain/convert/convert.test.ts) - ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ä¾‹
- [feature].ts - ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¡ã‚¤ãƒ³API
- [Feature]Repository.ts - Repositoryå±¤ã®ãƒ†ã‚¹ãƒˆå¯¾è±¡
- [Feature]Service.ts - Serviceå±¤ã®ãƒ†ã‚¹ãƒˆå¯¾è±¡
- [Feature]Mapper.ts - Mapperå±¤ã®ãƒ†ã‚¹ãƒˆå¯¾è±¡
