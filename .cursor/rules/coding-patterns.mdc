---
globs: app/src/**/*.ts
---

# ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã‚¹ã‚¿ã‚¤ãƒ«

## ğŸ¯ ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«

### 1. **é–¢æ•°ã®å‘½åè¦å‰‡**

```typescript
// âœ… æ­£ã—ã„å‘½å
async function fetch[Features](): Promise<Fetch[Features]Result>
async function fetch[Feature]ById(id: string): Promise<Fetch[Feature]Result>
function clearCache(): void
function getCacheStats(): object

// âŒ é¿ã‘ã‚‹ã¹ãå‘½å
async function get[Features]()  // æ›–æ˜§
async function fetch()          // å…·ä½“çš„ã§ãªã„
```

### 2. **å‹å®šç¾©ã®è¦å‰‡**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸçµæœå‹
export interface FetchResult<T> {
  success: boolean;
  data?: T;
  error?: string;
  metadata?: {
    timestamp: Date;
    executionTime: number;
    cacheHit?: boolean;
  };
}

// âœ… å‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ä½¿ç”¨
export type Fetch[Features]Result = FetchResult<[Feature][]>;
export type Fetch[Feature]Result = FetchResult<[Feature]>;
```

### 3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
try {
  const data = await someOperation();
  return {
    success: true,
    data,
    metadata: {
      timestamp: new Date(),
      executionTime: Date.now() - startTime,
    },
  };
} catch (error) {
  const executionTime = Date.now() - startTime;
  logger.error('æ“ä½œã‚¨ãƒ©ãƒ¼', error as Error, { executionTime });

  if (error instanceof [Feature]Error) {
    return {
      success: false,
      error: error.message,
      metadata: { timestamp: new Date(), executionTime },
    };
  }

  return {
    success: false,
    error: `ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`,
    metadata: { timestamp: new Date(), executionTime },
  };
}
```

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. **Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**

```typescript
export class [Feature]Repository {
  // âœ… ä¾å­˜æ€§æ³¨å…¥ã«ã‚ˆã‚‹ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
  constructor(
    private service: [Feature]Service,
    private mapper: [Feature]Mapper,
    private logger: ILogger,
    private cache: ICache<[Feature][]>
  ) {}

  // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ããƒ‡ãƒ¼ã‚¿å–å¾—
  async fetch[Features](id: string): Promise<[Feature][]> {
    const cacheKey = `[features]:${id}`;

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
    const cached = this.cache.get(cacheKey);
    if (cached) {
      this.logger.debug(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—: ${cacheKey}`);
      return cached;
    }

    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    this.logger.info(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ${id} ã‹ã‚‰å–å¾—ä¸­`);
    const data = await this.service.queryData(id);

    // å¤‰æ›å‡¦ç†
    const [features] = await Promise.all(
      data.results.map(async (item) => {
        const content = await this.service.getContent(item.id);
        return await this.mapper.mapTo[Feature](item, content);
      })
    );

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    this.cache.set(cacheKey, [features]);
    return [features];
  }
}
```

### 2. **Service ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**

```typescript
export class [Feature]Service {
  // âœ… ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãAPIå‘¼ã³å‡ºã—
  async queryData(id: string): Promise<[Feature]Response> {
    ValidatorFactory.validateId(id);

    const cacheKey = `data:${id}`;
    const cached = this.cache.get(cacheKey);
    if (cached) {
      this.logger.debug(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—: ${cacheKey}`);
      return cached;
    }

    this.logger.info(`APIã‹ã‚‰å–å¾—: ${id}`);

    return await this.retryManager.execute(async () => {
      const response = await this.externalApi.query({
        id: id,
      });

      this.cache.set(cacheKey, response);
      return response;
    });
  }
}
```

### 3. **Mapper ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…**

```typescript
export class [Feature]Mapper {
  // âœ… å‹å®‰å…¨ãªå¤‰æ›
  async mapTo[Feature](data: [Feature]Response, content: ContentResponse): Promise<[Feature]> {
    try {
      this.logger.debug(`ãƒ‡ãƒ¼ã‚¿ ${data.id} ã‚’å¤‰æ›ä¸­`);

      const [feature] = this.create[Feature]Model(data, content);
      ValidatorFactory.validate[Feature]([feature]);

      this.logger.debug(`å¤‰æ›å®Œäº†: ${data.id}`);
      return [feature];
    } catch (error) {
      this.logger.error(`å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${data.id}`, error as Error);
      throw new [Feature]Error(
        `ãƒ‡ãƒ¼ã‚¿ ${data.id} ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ`,
        ERROR_CODES.MAPPING_ERROR,
        { dataId: data.id, error: error instanceof Error ? error.message : 'Unknown error' }
      );
    }
  }

  // âœ… ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã§ã®è©³ç´°å®Ÿè£…
  private create[Feature]Model(data: [Feature]Response, content: ContentResponse): [Feature] {
    return {
      name: this.extractName(data),
      // ãã®ä»–ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      content,
    };
  }
}
```

## ğŸ”§ å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¿ãƒ¼ãƒ³
async function getDataWithCache<T>(
  cacheKey: string,
  cache: ICache<T>,
  fetchFunction: () => Promise<T>
): Promise<T> {
  const cached = cache.get(cacheKey);
  if (cached) {
    logger.debug(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: ${cacheKey}`);
    return cached;
  }

  logger.info(`ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­: ${cacheKey}`);
  const data = await fetchFunction();
  cache.set(cacheKey, data);
  return data;
}
```

### 2. **ãƒªãƒˆãƒ©ã‚¤ãƒ‘ã‚¿ãƒ¼ãƒ³**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸãƒªãƒˆãƒ©ã‚¤ãƒ‘ã‚¿ãƒ¼ãƒ³
async function executeWithRetry<T>(
  operation: () => Promise<T>,
  retryManager: RetryManager,
  context: string
): Promise<T> {
  return await retryManager.execute(async () => {
    logger.debug(`${context} ã‚’å®Ÿè¡Œä¸­`);
    return await operation();
  });
}
```

### 3. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³**

```typescript
// âœ… çµ±ä¸€ã•ã‚ŒãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³
function validateAndTransform<T>(
  data: any,
  validator: (data: any) => boolean,
  transformer: (data: any) => T,
  errorMessage: string
): T {
  if (!validator(data)) {
    throw new FetchError(errorMessage, ERROR_CODES.VALIDATION_ERROR);
  }

  try {
    return transformer(data);
  } catch (error) {
    throw new FetchError(
      `å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${errorMessage}`,
      ERROR_CODES.TRANSFORMATION_ERROR,
      { originalError: error instanceof Error ? error.message : 'Unknown error' }
    );
  }
}
```

## ğŸ“‹ å¿…é ˆå®Ÿè£…é …ç›®

### 1. **ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: ä¾å­˜æ€§æ³¨å…¥ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
constructor(
  private logger: ILogger,
  // ãã®ä»–ã®ä¾å­˜é–¢ä¿‚
) {}

// âœ… å¿…é ˆ: ãƒ­ã‚°å‡ºåŠ›
this.logger.info('æ“ä½œé–‹å§‹', { context });
this.logger.debug('è©³ç´°æƒ…å ±', { data });
this.logger.error('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ', error, { context });

// âœ… å¿…é ˆ: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
try {
  // æ“ä½œ
} catch (error) {
  this.logger.error('æ“ä½œã‚¨ãƒ©ãƒ¼', error as Error, { context });
  throw new FetchError('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', ERROR_CODES.SPECIFIC_ERROR);
}
```

### 2. **Repositoryå±¤ã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
const cacheKey = `resource:${identifier}`;
const cached = this.cache.get(cacheKey);
if (cached) return cached;

// âœ… å¿…é ˆ: ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
const data = await this.fetchData();
this.cache.set(cacheKey, data);
return data;
```

### 3. **Serviceå±¤ã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
ValidatorFactory.validateInput(input);

// âœ… å¿…é ˆ: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
return await this.retryManager.execute(async () => {
  return await this.externalApiCall();
});
```

### 4. **Mapperå±¤ã§å¿…é ˆ**

```typescript
// âœ… å¿…é ˆ: å‹å®‰å…¨ãªå¤‰æ›
const model = this.createModel(data);
ValidatorFactory.validateModel(model);
return model;

// âœ… å¿…é ˆ: ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãƒ­ã‚°
catch (error) {
  this.logger.error(`å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${identifier}`, error as Error);
  throw new FetchError(`å¤‰æ›å¤±æ•—: ${identifier}`, ERROR_CODES.MAPPING_ERROR);
}
```

## ğŸš« ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. **ç›´æ¥çš„ãªä¾å­˜é–¢ä¿‚**

```typescript
// âŒ ç¦æ­¢: ç›´æ¥ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
const service = new NotionDatabaseService(...);

// âŒ ç¦æ­¢: å¾ªç’°ä¾å­˜
class ServiceA {
  constructor(private serviceB: ServiceB) {}
}
class ServiceB {
  constructor(private serviceA: ServiceA) {}  // å¾ªç’°ä¾å­˜
}
```

### 2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ä¸å‚™**

```typescript
// âŒ ç¦æ­¢: ã‚¨ãƒ©ãƒ¼ã®ç„¡è¦–
try {
  await operation();
} catch (error) {
  // ä½•ã‚‚ã—ãªã„ - ç¦æ­¢
}

// âŒ ç¦æ­¢: ä¸€èˆ¬çš„ãªError
throw new Error('ã‚¨ãƒ©ãƒ¼');  // FetchErrorã‚’ä½¿ç”¨ã™ã¹ã
```

### 3. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®çœç•¥**

```typescript
// âŒ ç¦æ­¢: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—
return { name: data.name };  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¿…é ˆ

// âŒ ç¦æ­¢: å‹å®‰å…¨æ€§ã®ç„¡è¦–
function processData(data: any) {  // å…·ä½“çš„ãªå‹ã‚’ä½¿ç”¨ã™ã¹ã
  return data.someProperty;
}
```

## ğŸ“š å‚è€ƒå®Ÿè£…

- [fetch.ts](mdc:app/src/domain/fetch/fetch.ts) - ãƒ¡ã‚¤ãƒ³APIã®å®Ÿè£…ä¾‹
- [HabitRepository.ts](mdc:app/src/domain/fetch/repositories/HabitRepository.ts) - Repositoryãƒ‘ã‚¿ãƒ¼ãƒ³
- [NotionDatabaseService.ts](mdc:app/src/domain/fetch/services/NotionDatabaseService.ts) - Serviceãƒ‘ã‚¿ãƒ¼ãƒ³
- [HabitMapper.ts](mdc:app/src/domain/fetch/mappers/HabitMapper.ts) - Mapperãƒ‘ã‚¿ãƒ¼ãƒ³
- [ServiceFactory.ts](mdc:app/src/domain/fetch/factories/ServiceFactory.ts) - Factoryãƒ‘ã‚¿ãƒ¼ãƒ³
